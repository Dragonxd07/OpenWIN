local a,b,c,d,e,f,g,h,i,j,k,l,m,n={"/init.lua","/OS.lua","/boot.lua"},{},{},unicode,computer;local function o(p)local q={e.pullSignal(p or math.huge)}q[1]=q[1]or""if#q>0 and h.n>0 and(q[1]:match"key"and not h[q[5]]or q[1]:match"cl"and not h[q[4]])then return{""}end;c[q[4]or""]=q[1]=="key_down"and 1;if c[29]and(c[56]and c[46]or c[32])then return"F"end;return table.unpack(q)end;local function r(s)local t=component.list(s)()return t and component.proxy(t)end;local function u(v,w,x)local y,z=load("return "..v,w,F,x)if not y then y,z=load(v,w,F,x)end;if y then return xpcall(y,debug.traceback)else return F,z end end;local function A(B,C)n={}for D in B:gmatch"[^\r\n]+"do n[#n+1]=D:gsub("\t",C and"    "or"")end end;local function E(p,G,H)local I,J,v,K=e.uptime()+(p or math.huge)repeat J,K,K,v=o(I-e.uptime())if J=="F"or J=="key_down"and(v==G or G==0)then if H then H()end;return 1 end until e.uptime()>=I end;local L,M,N=r"gp"or{},r"pr",component.list"sc"()local O,P=M.getData(),M.setData;M.setData=function(Q,R)O=R and Q or(O:match"[a-f-0-9]+"and O:gsub("[a-f-0-9]+",Q)or Q)P(O)end;M.getData=function()return O:match"[a-f-0-9]+"or O end;e.setBootAddress=M.setData;e.getBootAddress=M.getData;h=select(2,pcall(load("return "..(O:match"#(.+)#"or""))))or{}i=O:match"*"h.n=#h;for S=1,#h do h[h[S]],h[S]=1,F end;if L and N then L.bind(N)k,l=L.maxResolution()g=l/2;L.setPaletteColor(9,0x002b36)L.setPaletteColor(11,0x8cb9c5)end;local function T(U,V,W,X,Y)L.setBackground(X or 0x002b36)L.setForeground(Y or 0x8cb9c5)L.set(U,V,W)end;local function Z(U,V,_,a0,a1,X,Y)L.setBackground(X or 0x002b36)L.setForeground(Y or 0x8cb9c5)L.fill(U,V,_,a0,a1)end;local function a2()Z(1,1,k,l," ")end;local function a3(a4)return math.ceil(k/2-a4/2)end;local function a5(V,B,X,Y)T(a3(d.len(B)),V,B,X,Y)end;local function a6(B,a7,a8,G,H,a9,z)if L and N then A(B)local aa,V=L.set,math.ceil(g-#n/2)L.setPaletteColor(9,0x002b36)L.setPaletteColor(11,0x8cb9c5)a2()if a7 then a5(V-1,a7,0x002b36,0xFFFFFF)V=V+1 end;for S=1,#n do a5(V,n[S])V=V+1 end;if a9 and L and N then L.set=function(...)L.setPaletteColor(9,0x969696)L.setPaletteColor(11,0xb4b4b4)aa(...)L.set=aa end end;return E(a8 or 0,G,H)end end;local function ab(z)return L and N and a6(z,[[¯\_(ツ)_/¯]],math.huge,0,e.shutdown,1)or error(z)end;local function ac(t)local r=component.proxy(t)if r and r.spaceTotal and t~=e.tmpAddress()then b[#b+1]={r,r.getLabel()or"N/A",t}for S=1,#a do if r.exists(a[S])then b[#b][4]=a[S]end end end end;local function ad()b={}ac(M.getData())for ae in pairs(component.list"f")do ac(M.getData()~=ae and ae or"")end end;local function af(B,ag)return d.len(B)>ag and d.sub(B,1,ag).."…"or B end;local function ah(ai,aj,V,ak,al)local ah,am,an,ao,U,ap,J,aq,v,K="",d.len(ai),1,1::ar::J,K,aq,v=o(.5)if J=="F"then ah=F;goto as elseif J=="key_down"then if aq>=32 and d.len(am..ah)<k-am-1 then ah=d.sub(ah,1,an-1)..d.char(aq)..d.sub(ah,an,-1)an=an+1 elseif aq==8 and#ah>0 then ah=d.sub(d.sub(ah,1,an-1),1,-2)..d.sub(ah,an,-1)an=an-1 elseif aq==13 then goto as elseif v==203 and an>1 then an=an-1 elseif v==205 and an<=d.len(ah)then an=an+1 elseif v==200 and al then ah=al;an=d.len(al)+1 elseif v==208 and al then ah=""an=1 end;ao=1 elseif J:match"cl"then ah=d.sub(ah,1,an-1)..aq..d.sub(ah,an,-1)an=an+d.len(aq)elseif J~="key_up"then ao=not ao end;U=ak and a3(d.len(ah)+am)or aj;ap=U+am+an-1;Z(1,V,k,1," ")T(U,V,ai..ah,0x002b36,0xFFFFFF)if ap<=k then T(ap,V,L.get(ap,V),ao and 0xFFFFFF or 0x002b36,ao and 0x002b36 or 0xFFFFFF)end;goto ar::as::Z(1,V,k,1," ")return ah end;local function at(...)local B=table.pack(...)for S=1,B.n do B[S]=tostring(B[S])end;A(table.concat(B,"    "),1)for S=1,#n do L.copy(1,1,k,l-1,0,-1)Z(1,l-1,k,1," ")T(1,l-1,n[S])end end;local function au(av,a9)local t=af(av[3],a9 and 36 or 6)return av[4]and("Boot%s %s from %s (%s)"):format(a9 and"ing"or"",av[4],av[2],t)or("Boot from %s (%s) is not available"):format(av[2],t)end;local function aw(av)if av[4]then local ax,Q,y,ay,z,aw=av[1].open(av[4],"r"),""::ar::y=av[1].read(ax,math.huge)if y then Q=Q..y;goto ar end;av[1].close(ax)aw=function()a6(au(av,1),F,.5,F,F,1)if M.getData()~=av[3]then M.setData(av[3])end;ay,z=u(Q,"="..av[4])if not ay then ab(z)end;return 1 end;Q=i and not j and a6("Hold any button to boot",F,math.huge,0,aw)or aw()end end;local function az(aA,V,aB,aC,aD)return{e=aA,s=1,y=V,k=aC,b=aB,d=function(aE,aF,aG)V=aE.y;aB=aE.b;Z(1,V-1,k,3," ",0x002b36)f=aG and f or aE;local aH,aI,aJ,U,aK,aL=0,aB==1 and 6 or 8;if aD then aD(aE)end;for S=1,#aE.e do aH=aH+d.len(aE.e[S].t)+aI end;aH=aH-aI;U=a3(aH)for S=1,#aE.e do aK,aL=aE.s==S and 1,aE.e[S]aJ=d.len(aL.t)if aK and not aF then Z(U-aI/2,V-(aB==1 and 0 or 1),aJ+aI,aB==1 and 1 or 3," ",0x8cb9c5)T(U,V,aL.t,0x8cb9c5,0x002b36)else T(U,V,aL.t,0x002b36,0x8cb9c5)end;U=U+aJ+aI end end}end;local function aM()j=1::aN::m=r"et"ad()local x,J,v,Q,aO,aP,aQ,av,r,aR,aS,aT,ax,y,aU,aV,K=setmetatable({print=at,proxy=r,os={sleep=function(p)E(p)end},read=function(al)at(" ")local Q=ah("",1,l-1,F,al)T(1,l-1,Q)return Q end},{__index=_G})aO=az({{t="Power off",a=function()e.shutdown()end},{t="Lua",a=function()a2()::ar::Q=ah("> ",1,l,F,Q)if Q then at("> "..Q)T(1,l,">")at(select(2,u(Q,"=stdin",x)))goto ar end;aQ(F,F,1,1)end}},g+2,1,function()f=aP;aQ(1,1,F,F)end)aO.e[#aO.e+1]=m and{t="Netboot",a=function()aT,Q=ah("URL: ",F,g+7,1),""if#aT>0 then ax,y=m.request(aT),""if ax then a6("Downloading "..aT.."...")::ar::y=ax.read()if y then Q=Q..y;goto ar end;ax.close()a6(select(2,u(Q,"=netboot"))or"is empty","Netboot:",math.huge,0)else a6("Invalid URL","Netboot:",math.huge,0)end end;aQ(F,F,1,1)end}if#b>0 then aU=#aO.e+1;aP=az({},g-2,2,function()f=aO;aQ(F,F,1,1)end,function(aE)av=b[aE.s]r=av[1]aV=r.spaceTotal()aR=r.isReadOnly()Z(1,g+5,k,3," ")a5(g+5,au(av),F,0xFFFFFF)a5(g+7,("Disk usage %s%% / %s / %s"):format(math.floor(r.spaceUsed()/(aV/100)),aR and"Read only"or"Read & Write",aV<2^20 and"FDD"or aV<2^20*12 and"HDD"or"RAID"))for S=aU,#aO.e do aO.e[S]=F end;if aR then aO.s=aO.s>#aO.e and#aO.e or aO.s else aO.e[aU]={t="Rename",a=function()aS=ah("New label: ",F,g+7,1)if#aS>0 then pcall(r.setLabel,aS)av[2]=af(aS,16)aP.e[aE.s].t=af(aS,6)end;aP:d(1,1)aO:d()end}aO.e[#aO.e+1]={t="Format",a=function()av[4]=F;r.remove("/")aP:d(1,1)aO:d()end}end;aO:d(1,1)end)for S=1,#b do aP.e[S]={t=af(b[S][2],6),a=function(aE)aw(b[aE.s])end}end else aO.y=g;aO.b=2 end;aQ=function(aW,aX,aY,aZ)a2()if aP then aP:d(aY,aZ)aO:d(aW,aX)else a5(g+4,"No drives available",0x002b36,0xFFFFFF)aO:d()end;a5(l,"Use ← ↑ → key to move cursor; Enter to do action; CTRL+D to shutdown")end;aQ(1,1)::ar::J,K,K,v=o()if J=="key_down"then if v==200 then f.k()elseif v==208 then f.k()elseif v==203 then f.s=f.s>1 and f.s-1 or#f.e;f:d()elseif v==205 then f.s=f.s<#f.e and f.s+1 or 1;f:d()elseif v==28 then f.e[f.s].a(f)end elseif J:match"component"then goto aN elseif J=="F"then e.shutdown()end;goto ar end;ad()a6("Hold CTRL to stay in bootloader",F,1.3,29,aM)for S=1,#b do if aw(b[S])then e.shutdown()end end;m=L and N and aM()or error"No drives available"